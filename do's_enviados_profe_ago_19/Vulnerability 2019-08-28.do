    foreach package in estout somersd resboot_mediation.pkg { 
				capture ssc install `package' 
        } 

* para poder formatear los resultados a nuestras convenciones latinoamericanas
 set dp comma
*PARA SABER SI HAY QUE INCORPORAR UNA NUEVA VARIABLE
*gen prec_sum_original = vul + prec1 + prec2 + prec3 + prec5 + prec6 + prec7 + prec8
*recode prec_sum_original (3/max= 1 "Prec") (0/2=0 "Ausencia Prec"), gen (precr1)

*gen prec_sum_nueva = vul + prec5 + prec6 + prec8
*recode prec_sum_nueva (3/max= 1 "Prec") (0/2=0 "Ausencia Prec"), gen (prec_nueva)
*recode prec_sum_nueva (2/max= 1 "Prec") (0/1=0 "Ausencia Prec"), gen (prec_nueva1)
*3 o más se reconoce precario.

*GSE ABC1 a C3, D y E.
capture drop gse_ac3
recode gse 1/3=0 4/5=1, gen(gse_ac3) label (Grupo Socioeconómico D y E)

**recodificamos el gse para dejar como grupo vulnerable a d y e**
*recode gse 1/3=0 4/5=1, gen (gse1) label(GSE D y E)
*tab gse1
***falta agregar etiqueta a esta variable para recordar**  

*Detalles precariedad
  **prec1= Contrato escrito; prec2= Tipo de contrato (distinto indef); 
  **prec3r= inconformidad con hrarios de trabajo actuales; 
  **prec5= Hrarios distintos a Diurno; prec6= remuneración; distinta a fija; 
  **prec7= Baja estabilidad laboral; prec8= Desempleado (lo mismo que desempleo)
  
*Tiene miedo de reclamar mejores condiciones de trabajo - MIEDO CONDICIONES
*Se siente indefenso/a ante el trato injusto de sus superiores - INDEFENSO TRATO
*Se siente preocupado de que le cambien las condiciones de su salario - CAMBIO CONDICIONES
*Tiene miedo de que lo despidan si no hace lo que le piden - 
*Se siente preocupado(a) de que lo/a despidan o no le renueven el contrato
*Se siente preocupado por lo difícil que sería encontrar otro trabajo en caso que lo despidan
*Le hacen sentir que usted puede ser fácilmente reemplazado (a)
 
***********
 **testeo inicial de las escalas**
 
alpha vul1 vul2 vul3 vul4 vul5 vul6 vul7, i
**la escala vul tiene un alpha de 0.85**

alpha NAQ1-NAQ22, i
alpha A47_top_1 A47_top_2 A47_top_3 A47_top_4 A47_top_5 A47_top_6, i
alpha A18_top_1 A18_top_2 A18_top_3 A18_top_4 A18_top_5 A18_top_6  A18_top_7 /// 
A18_top_8 A18_top_9 A18_top_10 aposoc1- aposoc6 A19_top_1- A19_top_4,i
alpha r1 r2 r3 r4 r5 r6 r7 e1 e2 e3, i
alpha s1-s5, i
alpha LID_DES1 LID_DES4 LID_DES8 LID_DES10, i

*en caso que satisfacción laboral no estén omitidos los 99s.
*forvalue i = 1/7 {
*gen satlab_`i' = A43_top_`i'
*recode satlab`i' 99=.
  
******************************************************************************
****************************************** 3 **********************************
******************************************************************************
*3.- Descripción de la muestra por variables de precarización (índice de 
*vulnerabilidad y precariedad laboral). 

 *por sexo
  foreach sexo of varlist mujer hombre {
  foreach s of varlist vul {
  foreach v of varlist NAQ_MyE ///
						k2_elevado ///
						iso desbalance_dic ///
						satlab_rec LA_Leyman ///
						estrechez gse_ac3 ///
						{
		estpost svy, subpop(`sexo'): tab `v' `s', count col format(%9,3g)
		estadd sca Vsvy=(sqrt(e(cun_Pear)/(e(N)*min((e(r)-1),(e(c)-1)))))
		esttab .  using "chi2_vul_prec.html", cell("count(fmt(%9,0fc)) col(fmt(%9,3fc))") ///
		scalars(F_Pear p_Pear Vsvy) nostar unstack mtitle(`e(colvar)') ///
		addnotes(`predicho' " por " `v' " y" `sexo') sfmt(%15,3g) plain ///
		append
  } 
 }
}

*******************************************************************************
**************************************** 4 *************************************
*******************************************************************************
 
*Para el artículo que no hemos empezado a preparar necesito contestar 
*(mediante análisis de cluster u otro método) a la siguiente pregunta: quiénes 
*son los trabajadores más precarizados, como se relaciona precarización con 
*violencia y a su vez con salud mental.  

*********************
*HL test is too sensitive to large sample sizes
*it’s testing whether there are non-linearities and interactions that are not 
*well approximated by your model.
*Archer, K. J., Lemeshow, S., & Hosmer, D. W. (2007). Goodness-of-fit tests for 
*logistic regression models when data are collected using a complex sampling design. 
*Computational Statistics & Data Analysis, 51(9), 4450-4464. doi: 10.1016/j.csda.2006.07.006
*No es muy recomendada su utilización.
*Hosmer, D., Lemeshow, S., & Sturdivant, R. (2013). Applied Logistic Regression. ///
*3rd ed. Hoboken, NJ: Wiley.

*linktest 
*We find that the prediction squared does have explanatory power, 
*so our specification is not as good as we thought
*conditional on the specification, the independent variables 
*are specified incorrectly
*dependent variable was misspecified
*dependent variable needs a transformation or “link” function to 
*properly relate to the independent
*variables. The idea of a link test is to add an independent variable 
*to the equation that is especially
*likely to be significant if there is a link error

************************ 

**para responder a la hipòtesis 1**
foreach sexo of varlist mujer hombre {
	/*relacion entre vul y NAQ-R**/
	svy, subpop(`sexo'): logit NAQ_MyE b0.vul, or
			esttab .  using "vul_VL.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo1_vul_VL por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
	/**relacion entre vul y NAQ-R  controlando por dimensiones de la organizacion ///
	*del trabajo**/
	svy, subpop(`sexo'): logit NAQ_MyE b0.vul b0.desbalance_dic b0.iso, or
			esttab .  using "vul_VL.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo2_vul_VL por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
	/**relacion entre vul y NAQ-R controlando por insatisfaccion laboral ///
	*y Liderazgo autoritario**/
	svy, subpop(`sexo'): logit NAQ_MyE b0.vul b0.satlab_rec b0.LA_Leyman, or
			esttab .  using "vul_VL.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo3_vul_VL por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
	/**relacion entre vul y NAQ-R controlando por variables socioeconòmicas**/
	svy, subpop(`sexo'): logit NAQ_MyE b0.vul b0.gse_ac3 b0.estrechez, or
			esttab .  using "vul_VL.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo4_vul_VL por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
	/**vul y NAQ-R controlando por todo**/
	svy, subpop(`sexo'): logit NAQ_MyE b0.vul  ///
			b0.desbalance_dic b0.iso ///
			b0.satlab_rec b0.LA_Leyman ///
			b0.gse_ac3 b0.estrechez ///
			, or
			esttab .  using "vul_VL.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo5_vul_VL por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
		  } 
*En la +última, controlando por todo, hay problemas con HL (0,042), sólo en mujeres


**se pierde significancia en hombres al controlar por dimensiones de la organizaciòn del trabajo, adquiriendo preponderancia la dimension de debalance**
**en la discusiòn vale la pena agregar que el LA tiene un fuertísimo impacto en el NAQ , datos no reportados en este artìculo muestran que** 
**los expuestos a LA tienen una chance 5 veces mayor de presentar VL controlando por vul, por ambas dimensiones de la org del trabajo; satisfacciòn laboral y GSE**


*ANDRÉS: En el modelo con todas las variables, la vulnerabilidad no predice VL
*(p= 0,068) para mujeres y hombres (0,734). En H la Vulnerabilidad no predice 
*controlando por Sat Lab ni con La Leyman.


**para responder a la hipótesis 2**
foreach sexo of varlist mujer hombre{
	/*relacion entre vul y Distrés **/
	svy, subpop(`sexo'): logit k2_elevado b0.vul, or
			esttab .  using "vul_SM.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo1_vul_SM por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
	/**relacion entre vul y Distrés controlando por dimensiones de la organizacion ///
	*del trabajo**/
	svy, subpop(`sexo'): logit k2_elevado b0.vul b0.desbalance_dic b0.iso, or
			esttab .  using "vul_SM.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo2_vul_SM por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
	/**relacion entre vul y Distrés controlando por insatisfaccion laboral ///
	*y Liderazgo autoritario**/
	svy, subpop(`sexo'): logit k2_elevado b0.vul b0.satlab_rec b0.LA_Leyman, or
			esttab .  using "vul_SM.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo3_vul_SM por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
	/**relacion entre vul y Distrés controlando por variables socioeconòmicas**/
	svy, subpop(`sexo'): logit k2_elevado b0.vul b0.gse_ac3 b0.estrechez, or
			esttab .  using "vul_SM.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo4_vul_SM por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
	/**vul y Distrés controlando por todo**/
	svy, subpop(`sexo'): logit k2_elevado b0.vul  ///
			b0.desbalance_dic b0.iso ///
			b0.satlab_rec b0.LA_Leyman ///
			b0.gse_ac3 b0.estrechez ///
			, or
			esttab .  using "vul_SM.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo5_vul_SM por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
		  } 
		  
*El test de Hosmer Lemesow para evaluar el ajuste de los modelos indica un mal ajuste
* esto podría indicar que en el modelo se omiten ciertas interacciones.

*ANDRÉS: En hombres pierde poder predictivo cuando se controlan por todas las var

		  
**para responder a la hipótesis 3**
**relacion entre NAQ y distres**
foreach sexo of varlist mujer hombre{
	/*relacion entre Distrés y NAQ**/
	svy, subpop(`sexo'): logit k2_elevado b0.NAQ_MyE b0.vul, or
			estadd sca df_out=(e(N) - e(df_m))
			esttab .  using "SM_VL2.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo1_SM_VL por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
	/**relacion entre Distrés y NAQ controlando por dimensiones de la organizacion ///
	*del trabajo**/
	svy, subpop(`sexo'): logit k2_elevado b0.NAQ_MyE b0.vul b0.desbalance_dic b0.iso, or
			estadd sca df_out=(e(N) - e(df_m))
			esttab .  using "SM_VL2.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo2_SM_VL por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
	/**relacion entre Distrés y NAQ controlando por insatisfaccion laboral ///
	*y Liderazgo autoritario**/
	svy, subpop(`sexo'): logit k2_elevado b0.NAQ_MyE b0.vul b0.satlab_rec b0.LA_Leyman, or
			estadd sca df_out=(e(N) - e(df_m))
			esttab .  using "SM_VL2.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo3_SM_VL por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
	/**relacion entre Distrés y NAQ controlando por variables socioeconòmicas**/
	svy, subpop(`sexo'): logit k2_elevado b0.NAQ_MyE b0.vul b0.gse_ac3 b0.estrechez, or
			estadd sca df_out=(e(N) - e(df_m))
			esttab .  using "SM_VL2.html", cells ("b(star fmt(3)) se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo4_SM_VL por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
	/**Distrés y NAQ controlando por todo**/
	svy, subpop(`sexo'): logit k2_elevado b0.NAQ_MyE b0.vul ///
			b0.desbalance_dic b0.iso ///
			b0.satlab_rec b0.LA_Leyman ///
			b0.gse_ac3 b0.estrechez ///
			, or
			estadd sca df_out=(e(N) - e(df_m))
			esttab .  using "SM_VL2.html", cells ("b(star fmt(3)label(OR))  se(par fmt(2)) p(fmt(3)) ci_l ci_u") eform ///
			stats(df_m df_out F p r2 N, fmt(%9,0g %9,0g 2 %9,3g 2 %9,0g) labels(F Sig. R-cuadrado "N. casos") layout(`""(@,@)"= @ "' @)) style(fixed) drop(0.*) ///
				addnotes("modelo5_SM_VL por" `sexo'"; Exponentiated coefficients") sfmt(%15,3g) plain ///
				append
				svylogitgof
				linktest
		  } 
		  
*El test de Hosmer Lemesow para evaluar el ajuste de los modelos indica un mal ajuste
* esto podría indicar que en el modelo se omiten ciertas interacciones.

*No funciona en Mujeres (p=.152) con todas las variables. Tampoco en Hombres (p= .117).

*Archer, K. J., & Lemeshow, S. (2006). Goodness-of-Fit Test for a Logistic Regression Model Fitted Using Survey Sample Data. Stata Journal, 6(1), 97-105.
*Para comparar si los supuestos de la prueba se cumplen.
*De todas formas Archer & Lemeshow (2006), muestran que el comando "svylogitgof"
*es bastante útil para comprobar el ajuste en muestras complejas.

*foreach sexo of varlist hombre mujer {
*	 logit precr1 b0.NAQ_MyE if `sexo' , or 
*			 estat gof, table group(10)
*}


*efectos significativos
	svy, subpop(mujer): logit k2_elevado b0.vul b0.desbalance_dic b0.iso ///
											b0.LA_Leyman b0.satlab_rec ///
											b0.estrechez b0.gse_ac3 ///
			, or
